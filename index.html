<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LAN Token Chat</title>
<style>
  :root{
    --bg:#0e1320; --card:#151c2f; --fg:#eaf0ff;
    --accent:#7aa2ff; --glass:rgba(255,255,255,.08); --border:rgba(255,255,255,.15);
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(135deg,#0b1020,#1a2238);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  a{color:var(--accent);text-decoration:none}
  .container{max-width:1000px;margin:0 auto;padding:20px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .title{font-weight:700;font-size:20px}
  .buttons{display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:14px;border:1px solid var(--border);background:linear-gradient(145deg,rgba(255,255,255,.06),rgba(255,255,255,.02));backdrop-filter: blur(10px);cursor:pointer;transition:transform .1s ease, box-shadow .2s ease}
  .btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:800px){.grid{grid-template-columns:1.2fr .8fr}}
  .card{background:var(--glass);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.25)}
  .subtle{opacity:.8;font-size:13px}

  /* Public preview */
  #preview{height:140px;overflow:auto;background:rgba(0,0,0,.15);border-radius:12px;padding:10px}
  .msg{margin:6px 0;padding:8px 10px;border-radius:12px;background:rgba(255,255,255,.06)}
  .ts{opacity:.7;font-size:11px;margin-left:6px}

  /* Modal */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:20px}
  .modal{width:min(560px,95vw);background:linear-gradient(145deg,rgba(255,255,255,.08),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:18px;backdrop-filter: blur(14px);padding:18px;transform:translateY(30px) scale(.98);opacity:0;transition:all .22s ease}
  .modal-bg.show{display:flex}
  .modal-bg.show .modal{transform:translateY(0) scale(1);opacity:1}
  .token-row{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.07);border:1px dashed var(--border);padding:8px 10px;border-radius:12px;margin:6px 0}
  .token-index{font-weight:700;opacity:.9;width:28px;display:flex;justify-content:center}
  .chip{padding:4px 8px;border-radius:10px;background:rgba(0,0,0,.25);border:1px solid var(--border);font-family:ui-monospace,Consolas,monospace}
  .icon-btn{cursor:pointer;border:none;border-radius:10px;padding:6px 8px;background:rgba(255,255,255,.07);border:1px solid var(--border)}
  .muted{opacity:.8;font-size:13px}

  /* Chat page */
  .nav{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .spacer{flex:1}
  #chatView{display:none}
  .chat-panel{background:rgba(0,0,0,.15);border:1px solid var(--border);border-radius:14px;display:flex;flex-direction:column;height:55vh;overflow:hidden}
  .chat-log{flex:1;overflow:auto;padding:12px}
  .bubble{max-width:75%;padding:8px 12px;margin:6px 0;border-radius:14px;position:relative;word-wrap:break-word}
  .me{margin-left:auto;background:#2b6fff}
  .other{margin-right:auto;background:#2c3352}
  .bubble .time{position:absolute;bottom:-16px;font-size:10px;opacity:.8}
  .me .time{right:6px}
  .other .time{left:6px}
  .input-row{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border);background:rgba(0,0,0,.1)}
  .input-row input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--fg)}
  .input-row button{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:linear-gradient(145deg,rgba(255,255,255,.07),rgba(255,255,255,.02));cursor:pointer}

  /* Split view */
  .split{display:none;flex-direction:column;gap:10px}
  .split .drag{height:10px;cursor:row-resize;background:rgba(255,255,255,.08);border:1px dashed var(--border);border-radius:8px}

  /* Online list */
  .online{display:flex;flex-wrap:wrap;gap:6px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.06);cursor:pointer}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="title">LAN Token Chat</div>
    <div class="buttons" id="homeBtns">
      <button class="btn" id="btnCreate">Create Private Channel</button>
      <button class="btn" id="btnJoin">Join Private Channel</button>
    </div>
    <div class="buttons" id="chatBtns" style="display:none">
      <button class="btn" id="btnHome">Home</button>
      <button class="btn" id="btnRequest">Request Private Chat</button>
    </div>
  </header>

  <!-- HOME VIEW -->
  <section id="homeView">
    <div class="grid">
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Public Chat (live preview)</div>
        <div class="subtle">Shows the last two public messages</div>
        <div id="preview" class="card" style="margin-top:10px"></div>
        <div style="margin-top:10px">
          <button class="btn" id="btnJoinPublic">Join Public Chat</button>
        </div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Private Channels</div>
        <div class="subtle">Create or join a private channel by token</div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <input id="joinToken" placeholder="Enter token to join" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--fg)">
          <button class="btn" id="btnJoinByToken">Join</button>
        </div>
        <div class="muted" style="margin-top:8px">Tip: click “Create Private Channel” to generate & manage your tokens</div>
      </div>
    </div>
  </section>

  <!-- CHAT VIEW (single or split) -->
  <section id="chatView">
    <div class="nav">
      <div style="font-weight:700">Room: <span id="roomLabel">public</span></div>
      <div class="spacer"></div>
      <div id="onlineWrap" class="subtle">Online: <span id="onlineCount">0</span></div>
    </div>

    <!-- Single panel (used until split is activated) -->
    <div id="single" class="chat-panel">
      <div id="chatLog" class="chat-log"></div>
      <div class="input-row">
        <input id="msg" placeholder="Type a message">
        <button id="send">Send</button>
      </div>
    </div>

    <!-- Split view: top = public, bottom = private -->
    <div id="split" class="split">
      <div id="pubPanel" class="chat-panel" style="height:45vh">
        <div class="nav" style="padding:6px 10px"><b>Public</b></div>
        <div id="pubLog" class="chat-log"></div>
        <div class="input-row">
          <input id="pubMsg" placeholder="Message to public">
          <button id="pubSend">Send</button>
        </div>
      </div>
      <div class="drag" id="dragBar" title="Drag to resize"></div>
      <div id="privPanel" class="chat-panel" style="height:35vh">
        <div class="nav" style="padding:6px 10px"><b>Private</b> <span id="privPeer" class="subtle" style="margin-left:8px"></span></div>
        <div id="privLog" class="chat-log"></div>
        <div class="input-row">
          <input id="privMsg" placeholder="Message to private room">
          <button id="privSend">Send</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:700;margin-bottom:6px">Online Users</div>
      <div id="online" class="online"></div>
    </div>
  </section>

  <!-- MODAL: Token Manager -->
  <div class="modal-bg" id="tokenModalBg">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Your Private Tokens</div>
        <button class="icon-btn" id="closeModal">✕</button>
      </div>
      <div class="muted">Tokens you created on this device (stored locally). Share a token so others can join your private space.</div>
      <div id="tokenList" style="margin-top:10px"></div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="btnGenerate">Create New Token</button>
      </div>
    </div>
  </div>
</div>

<script>
  // =============== STATE ===============
  const state = {
    username: null,
    currentRoom: "public",      // "public" or token
    publicWS: null,             // WebSocket for public room
    privateWS: null,            // WebSocket for active private room (in split)
    privateToken: null,         // token for the active private room
    privatePeer: null,          // username of peer for label
    previewMsgs: [],            // store last two public messages
    onlineUsers: [],            // public online users
  };

  // =============== UTILITIES ===============
  const $ = sel => document.querySelector(sel);
  const el = (tag, cls, txt) => { const e=document.createElement(tag); if(cls) e.className=cls; if(txt!=null) e.textContent=txt; return e; };
  const ts = () => new Date().toLocaleTimeString();

  function toast(msg){ alert(msg); } // quick/simple

  // Local token storage (this device's created tokens)
  function getLocalTokens(){
    try { return JSON.parse(localStorage.getItem("my_tokens")||"[]"); } catch{ return []; }
  }
  function setLocalTokens(list){
    localStorage.setItem("my_tokens", JSON.stringify(list));
    renderTokenList();
  }

  // =============== MODAL (Token manager) ===============
  const modalBg = $("#tokenModalBg");
  $("#btnCreate").onclick = async () => { openTokenModal(true); };
  $("#btnJoin").onclick = () => { openTokenModal(false); };

  $("#closeModal").onclick = () => modalBg.classList.remove("show");
  $("#btnGenerate").onclick = async () => {
    const res = await fetch("/api/create_token", {method:"POST"});
    const data = await res.json();
    const tokens = getLocalTokens();
    tokens.push(data.token);
    setLocalTokens(tokens);
  };

  function openTokenModal(generateFirst){
    renderTokenList();
    modalBg.classList.add("show");
    if(generateFirst && getLocalTokens().length === 0){
      $("#btnGenerate").click();
    }
  }

  function renderTokenList(){
    const list = $("#tokenList");
    list.innerHTML = "";
    const tokens = getLocalTokens();
    if(tokens.length === 0){
      list.append(el("div","muted","No tokens yet. Click “Create New Token”."));
      return;
    }
    tokens.forEach((t,i)=>{
      const row = el("div","token-row");
      row.append(el("div","token-index", String(i+1)));
      row.append(el("div","chip", t));
      const copy = el("button","icon-btn","Copy");
      copy.onclick = ()=>{ navigator.clipboard.writeText(t); toast("Copied: "+t); };
      const join = el("button","icon-btn","Join");
      join.onclick = ()=>{ modalBg.classList.remove("show"); joinPrivateByToken(t); };
      const del = el("button","icon-btn","✕");
      del.onclick = ()=>{
        const arr = getLocalTokens().filter(x=>x!==t);
        setLocalTokens(arr);
      };
      row.append(copy, join, del);
      list.append(row);
    });
  }

  // =============== HOME (Public preview + Join) ===============
  $("#btnJoinPublic").onclick = () => goChat("public");
  $("#btnJoinByToken").onclick = () => {
    const tok = $("#joinToken").value.trim();
    if(tok) goChat(tok);
  };

  function pushPreview(payload){
    if(payload.type==="chat"){
      const text = `[${payload.ts}] ${payload.from}: ${payload.text}`;
      state.previewMsgs.push(text);
      if(state.previewMsgs.length>2) state.previewMsgs.shift();
      renderPreview();
    }
  }
  function renderPreview(){
    const box = $("#preview");
    box.innerHTML = "";
    state.previewMsgs.forEach(m=>{
      const div = el("div","msg",m);
      box.append(div);
    });
  }

  function joinPrivateByToken(tok){
    // If already in chat view, switch to split view by opening private; otherwise go to chat first
    if($("#chatView").style.display === "none"){
      goChat("public", () => openPrivateSplit(tok, /*peer*/ null));
    } else {
      openPrivateSplit(tok, null);
    }
  }

  // =============== VIEW SWITCH ===============
  function showHome(){
    $("#homeView").style.display="block";
    $("#chatView").style.display="none";
    $("#homeBtns").style.display="flex";
    $("#chatBtns").style.display="none";
  }
  function showChat(){
    $("#homeView").style.display="none";
    $("#chatView").style.display="block";
    $("#homeBtns").style.display="none";
    $("#chatBtns").style.display="flex";
  }

  $("#btnHome").onclick = () => {
    // Close sockets if needed
    if(state.publicWS){ try{ state.publicWS.close(); }catch{}; state.publicWS=null; }
    if(state.privateWS){ try{ state.privateWS.close(); }catch{}; state.privateWS=null; }
    $("#split").style.display="none";
    $("#single").style.display="flex";
    $("#chatLog").innerHTML="";
    $("#pubLog").innerHTML="";
    $("#privLog").innerHTML="";
    $("#roomLabel").textContent = "public";
    state.currentRoom = "public";
    showHome();
  };

  // =============== CHAT (public) ===============
  $("#send").onclick = () => sendPublic();
  $("#msg").addEventListener("keydown",e=>{ if(e.key==="Enter") sendPublic(); });

  function askUsername(){
    let u = state.username || prompt("Enter username:");
    while(!u){ u = prompt("Username required:"); }
    state.username = u.trim();
  }

  async function goChat(room, onReady){
    askUsername();
    showChat();
    $("#roomLabel").textContent = room==="public" ? "public" : `private:${room}`;
    $("#single").style.display = "flex";
    $("#split").style.display = "none";

    // open public socket (always, because preview, user list, and signaling rely on it)
    await openPublicSocket();

    if(room !== "public"){
      // If user directly joined with token, open split private with public on top
      openPrivateSplit(room, null);
    }

    if(typeof onReady === "function") onReady();
  }

  async function openPublicSocket(){
    if(state.publicWS){ try{ state.publicWS.close(); }catch{} }
    const ws = new WebSocket(`ws://${location.host}/ws/public/${encodeURIComponent(state.username)}`);
    state.publicWS = ws;

    ws.onopen = ()=> {
      // request current user list
      ws.send(JSON.stringify({type:"who"}));
    };
    ws.onmessage = (ev)=>{
      const p = JSON.parse(ev.data);
      // mirror last two messages on home
      pushPreview(p);

      if(p.type==="chat"){
        appendBubble("#chatLog", p, p.from===state.username);
      } else if(p.type==="system"){
        appendSystem("#chatLog", p.message, p.ts);
      } else if(p.type==="users"){
        state.onlineUsers = p.users; renderOnline();
      } else if(p.type==="private_invite"){
        // incoming private request
        const accept = confirm(`${p.from} invited you to a private chat.\nToken: ${p.token}\nAccept?`);
        if(accept){
          // open split and notify requester
          openPrivateSplit(p.token, p.from);
          ws.send(JSON.stringify({type:"private_accept", to: p.from, token: p.token}));
        } else {
          ws.send(JSON.stringify({type:"private_deny", to: p.from, token: p.token}));
        }
      } else if(p.type==="private_accept"){
        // peer accepted; open split if not already
        if(state.privateToken !== p.token){
          openPrivateSplit(p.token, p.from);
        } else {
          // just set peer label if missing
          if(!state.privatePeer) state.privatePeer = p.from;
          $("#privPeer").textContent = `with ${state.privatePeer}`;
        }
      } else if(p.type==="private_deny"){
        toast(`${p.from} denied your private chat request.`);
      }
    };
    ws.onclose = ()=> appendSystem("#chatLog","Disconnected from public.",ts());
  }

  function sendPublic(){
    if(!state.publicWS) return;
    const v = $("#msg").value.trim();
    if(!v) return;
    state.publicWS.send(JSON.stringify({type:"chat", text:v}));
    $("#msg").value="";
  }

  // Online list & request UI
  $("#btnRequest").onclick = ()=>{
    if(state.onlineUsers.length===0){ toast("No one online."); return; }
    const name = prompt("Request private chat with which username?\nOnline:\n"+state.onlineUsers.join(", "));
    if(!name) return;
    const tok = prompt("Enter token to use for this private chat (leave blank to auto-generate):") || "";
    state.publicWS.send(JSON.stringify({type:"private_request", to:name, token: tok || undefined}));
  };

  function renderOnline(){
    $("#onlineCount").textContent = state.onlineUsers.length;
    const wrap = $("#online");
    wrap.innerHTML="";
    state.onlineUsers.forEach(u=>{
      const pill=el("div","pill",u);
      pill.onclick = ()=>{
        const tok = prompt(`Send private chat request to ${u}.\nEnter token (blank = auto-generate):`) || "";
        state.publicWS.send(JSON.stringify({type:"private_request", to:u, token: tok || undefined}));
      };
      wrap.append(pill);
    });
  }

  // =============== PRIVATE (split) ===============
  $("#pubSend").onclick = ()=> {
    const v = $("#pubMsg").value.trim();
    if(!v || !state.publicWS) return;
    state.publicWS.send(JSON.stringify({type:"chat", text:v}));
    $("#pubMsg").value="";
  };

  $("#privSend").onclick = ()=> {
    const v = $("#privMsg").value.trim();
    if(!v || !state.privateWS) return;
    state.privateWS.send(JSON.stringify({type:"chat", text:v}));
    $("#privMsg").value="";
  };

  function openPrivateSplit(token, peerName){
    state.privateToken = token;
    state.privatePeer = peerName || state.privatePeer;
    $("#privPeer").textContent = state.privatePeer ? `with ${state.privatePeer}` : `(token ${token})`;

    $("#single").style.display="none";
    $("#split").style.display="flex";
    $("#pubLog").innerHTML="";
    $("#privLog").innerHTML="";

    // Open (or reopen) private socket
    if(state.privateWS){ try{ state.privateWS.close(); }catch{} }
    const ws = new WebSocket(`ws://${location.host}/ws/${encodeURIComponent(token)}/${encodeURIComponent(state.username)}`);
    state.privateWS = ws;

    ws.onopen = ()=> appendSystem("#privLog","Connected to private.",ts());
    ws.onmessage = (ev)=>{
      const p = JSON.parse(ev.data);
      if(p.type==="chat"){
        appendBubble("#privLog", p, p.from===state.username);
      } else if(p.type==="system"){
        appendSystem("#privLog", p.message, p.ts);
      }
    };
    ws.onclose = ()=> appendSystem("#privLog","Private connection closed.",ts());

    // Ensure public panel still connected:
    if(!state.publicWS || state.publicWS.readyState!==1) openPublicSocket();

    // Draggable splitter
    initDrag();
  }

  function initDrag(){
    const drag = $("#dragBar");
    const pub = $("#pubPanel");
    const priv = $("#privPanel");
    let dragging=false, startY=0, startPubH=0, startPrivH=0;

    drag.onmousedown = (e)=>{
      dragging=true; startY=e.clientY;
      startPubH=pub.clientHeight; startPrivH=priv.clientHeight;
      document.body.style.userSelect="none";
    };
    window.onmousemove = (e)=>{
      if(!dragging) return;
      const dy = e.clientY - startY;
      let newPub = Math.max(120, startPubH + dy);
      let newPriv= Math.max(120, startPrivH - dy);
      pub.style.height = newPub+"px";
      priv.style.height = newPriv+"px";
    };
    window.onmouseup = ()=>{ dragging=false; document.body.style.userSelect=""; };
  }

  // =============== RENDER HELPERS ===============
  function appendBubble(sel, p, isMe){
    const log = $(sel);
    const b = el("div","bubble "+(isMe?"me":"other"));
    b.textContent = (isMe ? "" : (p.from+": ")) + p.text;
    const t = el("div","time",p.ts);
    b.append(t);
    log.append(b);
    log.scrollTop = log.scrollHeight;
  }
  function appendSystem(sel, text, time){
    const log = $(sel);
    const div = el("div","msg",""+text+(time?`  (${time})`:""));
    log.append(div);
    log.scrollTop = log.scrollHeight;
  }

  // =============== AUTO PREVIEW FEED ===============
  // Connect a lightweight public ws just for preview (without username prompt)
  (function previewSocket(){
    const anon = "preview-"+Math.random().toString(16).slice(2,6);
    const ws = new WebSocket(`ws://${location.host}/ws/public/${encodeURIComponent(anon)}`);
    ws.onmessage = (ev)=>{
      const p = JSON.parse(ev.data);
      if(p.type==="chat") pushPreview(p);
    };
    // don’t spam the server; close this preview when user navigates away or goes to chat
    window.addEventListener("beforeunload", ()=>ws.close());
    // when user actually enters chat, we'll close this one inside goChat() by reusing same room
  })();
</script>
</body>
</html>
